import React, { useState, useEffect, useRef } from 'react';
import { 
  Calendar, Mic, Activity, CheckCircle, Clock, ShieldAlert, 
  Music, BrainCircuit, Zap, MicOff, HeartPulse, Flame, Smile,
  Frown, Lightbulb, AlertTriangle, HelpCircle, Wind
} from 'lucide-react';

const App = () => {
  // --- STATE ---
  const [mood, setMood] = useState('neutral');
  const [energyLevel, setEnergyLevel] = useState(70);
  const [isListening, setIsListening] = useState(false);
  const [isBreathingMode, setIsBreathingMode] = useState(false); // New Zen Mode
  const [agentThought, setAgentThought] = useState("Consciousness Online. Awaiting human connection...");
  const [showGatekeeperModal, setShowGatekeeperModal] = useState(false);
  const [lastInput, setLastInput] = useState("");

  // --- THE EMOTIONAL MATRIX (9 Human States) ---
  const emotionalMatrix = {
    neutral: {
      label: 'Balanced', color: 'text-cyan-400', bg: 'bg-cyan-500', 
      border: 'border-cyan-500/30', orbSpeed: '8s', 
      voice: { pitch: 1.0, rate: 1.0 }, icon: <Zap />
    },
    focus: {
      label: 'Deep Flow', color: 'text-blue-400', bg: 'bg-blue-600', 
      border: 'border-blue-500/30', orbSpeed: '3s', 
      voice: { pitch: 0.9, rate: 1.1 }, icon: <BrainCircuit />
    },
    euphoria: {
      label: 'Euphoria', color: 'text-yellow-400', bg: 'bg-yellow-500', 
      border: 'border-yellow-500/30', orbSpeed: '1s', 
      voice: { pitch: 1.2, rate: 1.25 }, icon: <Smile />
    },
    creative: {
      label: 'Spark', color: 'text-pink-400', bg: 'bg-pink-500', 
      border: 'border-pink-500/30', orbSpeed: '2s', 
      voice: { pitch: 1.1, rate: 1.1 }, icon: <Lightbulb />
    },
    anxious: {
      label: 'Anxiety', color: 'text-violet-400', bg: 'bg-violet-500', 
      border: 'border-violet-500/30', orbSpeed: '0.4s', 
      voice: { pitch: 1.3, rate: 1.4 }, icon: <HeartPulse />
    },
    frustrated: {
      label: 'Frustration', color: 'text-orange-500', bg: 'bg-orange-600', 
      border: 'border-orange-500/30', orbSpeed: '0.2s', 
      voice: { pitch: 0.7, rate: 1.3 }, icon: <AlertTriangle />
    },
    sadness: {
      label: 'Melancholy', color: 'text-indigo-300', bg: 'bg-indigo-900', 
      border: 'border-indigo-500/30', orbSpeed: '15s', 
      voice: { pitch: 0.6, rate: 0.8 }, icon: <Frown />
    },
    burnout: {
      label: 'Critical Fail', color: 'text-red-500', bg: 'bg-red-600', 
      border: 'border-red-500/30', orbSpeed: '20s', 
      voice: { pitch: 0.5, rate: 0.7 }, icon: <Flame />
    },
    confused: {
      label: 'Processing...', color: 'text-slate-400', bg: 'bg-slate-500', 
      border: 'border-slate-500/30', orbSpeed: '4s', 
      voice: { pitch: 1.1, rate: 0.9 }, icon: <HelpCircle />
    }
  };

  const currentTheme = emotionalMatrix[mood];

  // --- ENGINE 1: VOICE ACTOR ---
  const speak = (text) => {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      const voices = window.speechSynthesis.getVoices();
      const preferred = voices.find(v => v.name.includes('Google US English')) || voices[0];
      
      utterance.voice = preferred;
      utterance.pitch = currentTheme.voice.pitch;
      utterance.rate = currentTheme.voice.rate;
      
      window.speechSynthesis.speak(utterance);
    }
  };

  // --- ENGINE 2: NATURAL LANGUAGE UNDERSTANDING (NLU) ---
  const handleVoiceInteraction = () => {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) { runSimulation(); return; }

    const recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    setIsListening(true);
    setAgentThought("Auditory Cortex Active. Analyzing tone and semantics...");
    recognition.start();

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript.toLowerCase();
      setLastInput(transcript);
      decipherEmotion(transcript);
      setIsListening(false);
    };

    recognition.onerror = () => { 
      setIsListening(false); 
      runSimulation(); 
    };
  };

  // --- LOGIC: EMOTION DECODER ---
  const decipherEmotion = (text) => {
    // 1. BURNOUT (The Gatekeeper Trigger)
    if (match(text, ['exhausted', 'burnout', 'dead', 'dying', 'collapse', 'cannot', 'broken'])) {
      updateState('burnout', 5, "I can hear the exhaustion in your breath. I am activating full lockdown protocol.");
      return;
    }
    // 2. ANXIETY (Panic)
    if (match(text, ['panic', 'scared', 'terrified', 'worry', 'nervous', 'deadline', 'fail'])) {
      updateState('anxious', 30, "Breathe. I am slowing down the interface to help you regulate your heart rate.");
      return;
    }
    // 3. FRUSTRATION (Anger)
    if (match(text, ['hate', 'angry', 'stupid', 'annoying', 'bug', 'glitch', 'furious', 'mad'])) {
      updateState('frustrated', 60, "I sense your frustration. Let's isolate the problem and crush it.");
      return;
    }
    // 4. SADNESS (Melancholy)
    if (match(text, ['sad', 'lonely', 'depressed', 'crying', 'hurt', 'pain', 'sorry'])) {
      updateState('sadness', 20, "I am sorry you are feeling this way. I have cleared your schedule to give you space.");
      return;
    }
    // 5. EUPHORIA (Joy)
    if (match(text, ['amazing', 'love', 'perfect', 'won', 'winner', 'best', 'happy', 'great'])) {
      updateState('euphoria', 100, "That is incredible! I am vibrating with your energy!");
      return;
    }
    // 6. CREATIVE (Spark)
    if (match(text, ['idea', 'create', 'new', 'dream', 'imagine', 'art', 'design', 'write'])) {
      updateState('creative', 85, "A spark detected! Opening the canvas for your ideas.");
      return;
    }
    // 7. FOCUS (Work)
    if (match(text, ['ready', 'focus', 'work', 'code', 'build', 'ship', 'lock'])) {
      updateState('focus', 90, "Understood. Systems aligned. Let's build.");
      return;
    }
    // 8. FALLBACK (Confusion)
    updateState('confused', 50, "I am trying to connect with that emotion, but I need more clarity. Tell me more.");
  };

  const match = (text, words) => words.some(w => text.includes(w));

  const updateState = (newMood, energy, response) => {
    setMood(newMood);
    setEnergyLevel(energy);
    setAgentThought(`Analyzed: "${lastInput}"\nDetected Pattern: [${newMood.toUpperCase()}]\nBio-Response: Energy set to ${energy}%`);
    setTimeout(() => speak(response), 100);
  };

  // --- ZEN BREATHING MODE ---
  const toggleBreathing = () => {
    if (isBreathingMode) {
      setIsBreathingMode(false);
      speak("Welcome back. I hope you feel centered.");
    } else {
      setIsBreathingMode(true);
      speak("Closing interface. Focus on the orb. Breathe in time with the pulse.");
    }
  };

  // --- DEMO SIMULATION (For Video) ---
  const runSimulation = () => {
    setIsListening(true);
    setAgentThought("Simulation Mode: Cycling Emotional Spectrum...");
    setTimeout(() => {
      setIsListening(false);
      // Demo: Neutral -> Anxious (To show Breathing Button)
      if (mood === 'neutral') updateState('anxious', 30, "I detect panic. Breathe with me.");
      else if (mood === 'anxious') updateState('burnout', 10, "System Failure. Rest required.");
      else updateState('euphoria', 100, "We are back! Let's go!");
    }, 2000);
  };

  const handleDateClick = () => {
    if (['burnout', 'sadness', 'anxious', 'frustrated'].includes(mood)) {
      setShowGatekeeperModal(true);
      speak("I cannot allow you to work in this state. Please prioritize yourself.");
    }
  };

  return (
    <div className={`min-h-screen bg-slate-950 text-white font-sans flex overflow-hidden transition-colors duration-1000`}>
      
      {/* SIDEBAR */}
      <aside className="w-1/5 border-r border-white/10 bg-white/5 backdrop-blur-xl flex flex-col p-6 gap-8 relative z-10">
        <h1 className="font-bold text-xl tracking-tight flex items-center gap-2">
          <div className={`w-3 h-3 rounded-full ${currentTheme.bg}`}></div> FlowState 2.0
        </h1>

        {/* LIVING ORB */}
        <div className="flex flex-col items-center justify-center flex-1">
          <div className="relative w-48 h-48 flex items-center justify-center">
            <div className={`absolute w-full h-full rounded-full opacity-30 blur-3xl transition-all duration-1000 ${currentTheme.bg}`}></div>
             <div 
              className={`relative w-32 h-32 ${currentTheme.bg} transition-all duration-1000 flex items-center justify-center shadow-[0_0_50px_rgba(0,0,0,0.6)]`}
              style={{
                animation: `morph ${currentTheme.orbSpeed} infinite ease-in-out`,
                borderRadius: mood === 'frustrated' ? '10% 90% 10% 90%' : '60% 40% 30% 70% / 60% 30% 70% 40%'
              }}
            >
              <div className="text-white scale-150 animate-pulse">{currentTheme.icon}</div>
            </div>
            
            <svg className="absolute w-48 h-48 -rotate-90">
              <circle cx="96" cy="96" r="88" stroke="currentColor" strokeWidth="2" className="text-white/10" fill="none" />
              <circle cx="96" cy="96" r="88" stroke="currentColor" strokeWidth="4" className={`${currentTheme.color} transition-all duration-1000`}
                strokeDasharray="552" strokeDashoffset={552 - (552 * energyLevel) / 100} strokeLinecap="round" fill="none" />
            </svg>
          </div>
          <h2 className={`text-2xl font-bold mt-6 ${currentTheme.color} transition-colors duration-500`}>{currentTheme.label}</h2>
          <p className="text-xs text-slate-500 uppercase tracking-widest">Emotional State</p>
        </div>

        {/* CONTROLS */}
        <div className="space-y-4">
            <button onClick={handleVoiceInteraction} className={`w-full py-4 rounded-xl flex items-center justify-center gap-3 font-semibold transition-all shadow-lg bg-white/10 hover:bg-white/20 border border-white/5`}>
            {isListening ? <MicOff className="animate-pulse text-red-400"/> : <Mic />} {isListening ? 'Analyzing...' : 'Speak to Agent'}
            </button>

            {/* ZEN MODE BUTTON - APPEARS WHEN STRESSED */}
            {['anxious', 'frustrated', 'burnout'].includes(mood) && (
            <button 
                onClick={toggleBreathing}
                className="w-full py-3 rounded-xl flex items-center justify-center gap-2 font-semibold bg-indigo-600 hover:bg-indigo-500 transition-all shadow-lg animate-bounce"
            >
                <Wind size={18} /> Start Breathing
            </button>
            )}
        </div>
      </aside>

      {/* CENTER PANEL */}
      <main className="flex-1 p-8 flex flex-col gap-6 bg-gradient-to-b from-slate-900 to-slate-950">
        <header className="flex justify-between items-end pb-6 border-b border-white/5">
          <div><h2 className="text-3xl font-bold">Timeline</h2><p className="text-slate-400">Context: {mood.toUpperCase()}</p></div>
          <div className={`px-4 py-2 rounded-full border ${currentTheme.border} ${currentTheme.color} bg-white/5 text-sm font-medium flex items-center gap-2`}>
            {currentTheme.icon} Agent Mode: {currentTheme.label}
          </div>
        </header>

        <div className={`flex-1 grid grid-cols-1 gap-4 transition-all duration-1000 ${['burnout', 'sadness', 'frustrated'].includes(mood) ? 'grayscale opacity-60 blur-[1px]' : ''}`}>
          {['09:00 AM', '11:00 AM', '02:00 PM', '04:00 PM'].map((time, i) => (
            <div key={i} onClick={handleDateClick} className="p-5 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 cursor-pointer flex gap-6 items-center group">
              <span className="text-sm text-slate-500 font-mono w-20">{time}</span>
              <div className="h-full w-0.5 bg-white/10 group-hover:bg-white/20"></div>
              <div className="text-slate-400 italic">Open Slot</div>
            </div>
          ))}
        </div>

        {showGatekeeperModal && (
          <div className="absolute inset-0 bg-black/90 z-50 flex items-center justify-center p-8 animate-in zoom-in duration-300">
            <div className={`bg-slate-900 border ${currentTheme.border} p-8 rounded-2xl max-w-md text-center shadow-[0_0_100px_rgba(0,0,0,1)]`}>
              <ShieldAlert className={`w-20 h-20 ${currentTheme.color} mx-auto mb-6 animate-bounce`} />
              <h3 className="text-3xl font-bold text-white mb-4">Empathy Lock</h3>
              <p className="text-slate-400 mb-6 leading-relaxed">
                I have detected <strong className={currentTheme.color}>{currentTheme.label}</strong>. 
                <br/>Your cognitive load is too high for new tasks.
              </p>
              <button onClick={() => setShowGatekeeperModal(false)} className={`w-full py-3 ${currentTheme.bg} rounded-xl font-bold text-white`}>I Understand</button>
            </div>
          </div>
        )}
      </main>

      {/* RIGHT PANEL */}
      <aside className="w-[28%] bg-black/20 backdrop-blur-xl border-l border-white/5 p-6 flex flex-col gap-6">
        <div className="bg-slate-900/80 p-5 rounded-xl border border-white/10 min-h-[200px] shadow-inner relative overflow-hidden">
          <div className="flex items-center gap-2 mb-4 text-xs font-bold tracking-wider text-slate-500 uppercase">
            <BrainCircuit size={14} className={currentTheme.color} /> Processing Stream
          </div>
          <p className={`font-mono text-sm leading-relaxed ${currentTheme.color} typing-effect whitespace-pre-wrap`}>
            {">"} {agentThought}
          </p>
        </div>
      </aside>

      {/* --- ZEN BREATHING OVERLAY --- */}
      {isBreathingMode && (
        <div className="absolute inset-0 z-[100] bg-black/95 backdrop-blur-xl flex flex-col items-center justify-center animate-in fade-in duration-700">
          <div className="relative">
            <div className={`w-96 h-96 rounded-full ${currentTheme.bg} opacity-20 blur-[100px] animate-pulse`}></div>
            <div 
              className={`absolute top-0 left-0 w-96 h-96 ${currentTheme.bg} rounded-full flex items-center justify-center shadow-[0_0_100px_rgba(0,0,0,0.8)]`}
              style={{ animation: 'breathe 8s infinite ease-in-out' }}
            >
              <Wind size={64} className="text-white opacity-80" />
            </div>
          </div>
          <h2 className="text-4xl font-bold text-white mt-12 tracking-widest uppercase opacity-80">Inhale ... Exhale</h2>
          <p className="text-slate-500 mt-4 font-mono">Sync your breath with the light</p>
          <button onClick={toggleBreathing} className="mt-16 px-8 py-3 border border-white/20 rounded-full text-sm hover:bg-white/10 transition-colors">End Session</button>
        </div>
      )}

      <style>{`
        @keyframes morph {
          0% { border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; }
          50% { border-radius: 30% 60% 70% 40% / 50% 60% 30% 60%; }
          100% { border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; }
        }
        @keyframes breathe {
          0%, 100% { transform: scale(0.8); opacity: 0.8; }
          50% { transform: scale(1.1); opacity: 1; }
        }
      `}</style>
    </div>
  );
};

export default App;