import React, { useState, useEffect } from 'react';
import { 
  Calendar, Mic, Activity, CheckCircle, Clock, ShieldAlert, 
  Music, BrainCircuit, Zap, MicOff, HeartPulse, Flame, Smile
} from 'lucide-react';

const App = () => {
  // --- STATE: THE EMOTIONAL CORE ---
  const [mood, setMood] = useState('neutral'); // neutral | focus | anxious | burnout | euphoria
  const [energyLevel, setEnergyLevel] = useState(70);
  const [isListening, setIsListening] = useState(false);
  const [agentThought, setAgentThought] = useState("Emotional Core Online. Waiting for human input...");
  const [showGatekeeperModal, setShowGatekeeperModal] = useState(false);

  // --- CONFIG: THE FEELINGS MAP ---
  const moodConfig = {
    neutral: {
      color: 'text-cyan-400', bg: 'bg-cyan-500', glow: 'shadow-cyan-500/50', border: 'border-cyan-500/30',
      orbSpeed: '8s', voicePitch: 1.0, voiceRate: 1.0,
      icon: <Zap size={16} />, label: 'Balanced'
    },
    focus: {
      color: 'text-blue-400', bg: 'bg-blue-600', glow: 'shadow-blue-500/50', border: 'border-blue-500/30',
      orbSpeed: '3s', voicePitch: 0.9, voiceRate: 1.1, // Professional, slightly fast
      icon: <BrainCircuit size={16} />, label: 'Deep Focus'
    },
    anxious: {
      color: 'text-violet-400', bg: 'bg-violet-500', glow: 'shadow-violet-500/50', border: 'border-violet-500/30',
      orbSpeed: '0.5s', voicePitch: 1.2, voiceRate: 1.3, // Jittery, fast, high pitch
      icon: <HeartPulse size={16} />, label: 'High Anxiety'
    },
    burnout: {
      color: 'text-red-500', bg: 'bg-red-600', glow: 'shadow-red-500/50', border: 'border-red-500/30',
      orbSpeed: '15s', voicePitch: 0.6, voiceRate: 0.8, // Slow, deep, tired
      icon: <Flame size={16} />, label: 'Critical Burnout'
    },
    euphoria: {
      color: 'text-yellow-400', bg: 'bg-yellow-500', glow: 'shadow-yellow-500/50', border: 'border-yellow-500/30',
      orbSpeed: '2s', voicePitch: 1.3, voiceRate: 1.2, // Happy, bouncy
      icon: <Smile size={16} />, label: 'Euphoria'
    }
  };

  const currentTheme = moodConfig[mood];

  // --- ENGINE: HUMAN-LIKE VOICE ---
  const speak = (text) => {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      const voices = window.speechSynthesis.getVoices();
      // Try to find a good English voice
      const preferred = voices.find(v => v.name.includes('Google US English')) || voices[0];
      
      utterance.voice = preferred;
      // APPLY EMOTION TO VOICE
      utterance.pitch = currentTheme.voicePitch; 
      utterance.rate = currentTheme.voiceRate;
      
      window.speechSynthesis.speak(utterance);
    }
  };

  // --- ENGINE: EMOTION ANALYSIS ---
  const handleVoiceInteraction = () => {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) { runSimulation(); return; }

    const recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    setIsListening(true);
    setAgentThought("Listening for emotional cues...");
    recognition.start();

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript.toLowerCase();
      analyzeEmotion(transcript);
      setIsListening(false);
    };

    recognition.onerror = () => { 
      setIsListening(false); 
      runSimulation(); // Auto-fallback to simulation if mic fails
    };
  };

  const analyzeEmotion = (text) => {
    // 1. ANXIETY TRIGGERS
    if (['worry', 'panic', 'deadline', 'scared', 'nervous', 'much', 'overwhelmed'].some(w => text.includes(w))) {
      triggerState('anxious', 40, text, "I detect panic in your voice. Breathe. I am slowing down the interface.");
    }
    // 2. BURNOUT TRIGGERS
    else if (['tired', 'exhausted', 'done', 'stop', 'hate', 'bad', 'sick'].some(w => text.includes(w))) {
      triggerState('burnout', 10, text, "System Critical. You sound exhausted. Gatekeeper protocols active.");
    }
    // 3. EUPHORIA TRIGGERS
    else if (['happy', 'love', 'great', 'amazing', 'won', 'yes', 'excited'].some(w => text.includes(w))) {
      triggerState('euphoria', 100, text, "That sounds amazing! I'm vibrating with energy with you!");
    }
    // 4. FOCUS TRIGGERS
    else if (['work', 'code', 'focus', 'ready', 'build', 'lock'].some(w => text.includes(w))) {
      triggerState('focus', 85, text, "Understood. Locking in. Let's build something great.");
    }
    // 5. NEUTRAL
    else {
      triggerState('neutral', 60, text, "I hear you. Staying balanced.");
    }
  };

  // --- SIMULATION (For Demo Video) ---
  const runSimulation = () => {
    setIsListening(true);
    setAgentThought("Simulating Emotional Input...");
    setTimeout(() => {
      setIsListening(false);
      // Cycle through moods for demo
      if (mood === 'neutral') triggerState('anxious', 40, "I am panicking about the deadline!", "I detect panic. Breathe.");
      else if (mood === 'anxious') triggerState('burnout', 10, "I just can't do this anymore.", "System Critical. Gatekeeper active.");
      else if (mood === 'burnout') triggerState('euphoria', 100, "Wait, I just fixed the bug! It works!", "That is amazing! Let's go!");
      else triggerState('focus', 90, "Okay, back to work.", "Understood. Locking in.");
    }, 2000);
  };

  const triggerState = (newMood, energy, input, response) => {
    setMood(newMood);
    setEnergyLevel(energy);
    setAgentThought(`Input: "${input}" -> Emotion Detected: ${newMood.toUpperCase()} -> Adjusting UI/Voice.`);
    // We delay speech slightly so the state updates first (so voice pitch changes)
    setTimeout(() => speak(response), 100);
  };

  // --- GATEKEEPER LOGIC ---
  const handleDateClick = () => {
    if (mood === 'burnout' || mood === 'anxious') {
      setShowGatekeeperModal(true);
      speak("No. I cannot let you work right now. Please rest.");
    }
  };

  return (
    <div className={`min-h-screen bg-slate-950 text-white font-sans flex overflow-hidden transition-colors duration-1000`}>
      
      {/* SIDEBAR */}
      <aside className="w-1/5 border-r border-white/10 bg-white/5 backdrop-blur-xl flex flex-col p-6 gap-8 relative z-10">
        <h1 className="font-bold text-xl tracking-tight flex items-center gap-2">
          <div className={`w-3 h-3 rounded-full ${currentTheme.bg}`}></div> FlowState
        </h1>

        {/* EMOTIONAL ORB */}
        <div className="flex flex-col items-center justify-center flex-1">
          <div className="relative w-48 h-48 flex items-center justify-center">
            <div className={`absolute w-full h-full rounded-full opacity-30 blur-3xl transition-all duration-1000 ${currentTheme.bg}`}></div>
             <div 
              className={`relative w-32 h-32 ${currentTheme.bg} transition-all duration-1000 flex items-center justify-center shadow-[0_0_50px_rgba(0,0,0,0.6)]`}
              style={{
                animation: `morph ${currentTheme.orbSpeed} infinite ease-in-out`,
                borderRadius: '60% 40% 30% 70% / 60% 30% 70% 40%'
              }}
            >
              <div className="text-white scale-150">{currentTheme.icon}</div>
            </div>
            
            {/* Energy Ring */}
            <svg className="absolute w-48 h-48 -rotate-90">
              <circle cx="96" cy="96" r="88" stroke="currentColor" strokeWidth="2" className="text-white/10" fill="none" />
              <circle 
                cx="96" cy="96" r="88" 
                stroke="currentColor" strokeWidth="4" 
                className={`${currentTheme.color} transition-all duration-1000`}
                strokeDasharray="552"
                strokeDashoffset={552 - (552 * energyLevel) / 100}
                strokeLinecap="round"
                fill="none" 
              />
            </svg>
          </div>
          <h2 className={`text-2xl font-bold mt-6 ${currentTheme.color} transition-colors duration-500`}>{currentTheme.label}</h2>
          <p className="text-xs text-slate-500 uppercase tracking-widest">Emotional State</p>
        </div>

        {/* CONTROLS */}
        <div className="space-y-4">
          <button onClick={handleVoiceInteraction} className={`w-full py-4 rounded-xl flex items-center justify-center gap-3 font-semibold transition-all shadow-lg bg-white/10 hover:bg-white/20`}>
            {isListening ? 'Listening...' : 'Talk to Agent'}
          </button>
        </div>
      </aside>

      {/* CENTER PANEL */}
      <main className="flex-1 p-8 flex flex-col gap-6 bg-gradient-to-b from-slate-900 to-slate-950">
        <header className="flex justify-between items-end pb-6 border-b border-white/5">
          <div><h2 className="text-3xl font-bold">Schedule</h2><p className="text-slate-400">Current Vibe: {mood.toUpperCase()}</p></div>
          <div className={`px-4 py-2 rounded-full border ${currentTheme.border} ${currentTheme.color} bg-white/5 text-sm font-medium flex items-center gap-2`}>
            {currentTheme.icon} Status: {currentTheme.label}
          </div>
        </header>

        {/* CALENDAR */}
        <div className={`flex-1 grid grid-cols-1 gap-4 transition-all duration-1000 ${mood === 'burnout' ? 'grayscale opacity-50 blur-sm' : ''} ${mood === 'anxious' ? 'animate-pulse' : ''}`}>
          {['09:00 AM', '11:00 AM', '02:00 PM'].map((time, i) => (
            <div key={i} onClick={handleDateClick} className="p-5 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 cursor-pointer flex gap-6 items-center">
              <span className="text-sm text-slate-500 font-mono w-20">{time}</span>
              <div className="h-full w-0.5 bg-white/10"></div>
              <div className="text-slate-400 italic">Available Slot</div>
            </div>
          ))}
        </div>

        {/* MODAL */}
        {showGatekeeperModal && (
          <div className="absolute inset-0 bg-black/90 z-50 flex items-center justify-center p-8">
            <div className={`bg-slate-900 border ${currentTheme.border} p-8 rounded-2xl max-w-md text-center shadow-2xl`}>
              <ShieldAlert className={`w-20 h-20 ${currentTheme.color} mx-auto mb-6`} />
              <h3 className="text-3xl font-bold text-white mb-4">Boundary Enforcement</h3>
              <p className="text-slate-400 mb-6">I detected {mood}. I cannot allow you to add more tasks.</p>
              <button onClick={() => setShowGatekeeperModal(false)} className={`w-full py-3 ${currentTheme.bg} rounded-xl font-bold`}>Close</button>
            </div>
          </div>
        )}
      </main>

      {/* RIGHT PANEL */}
      <aside className="w-[28%] bg-black/20 backdrop-blur-xl border-l border-white/5 p-6 flex flex-col gap-6">
        <div className="bg-slate-900/80 p-5 rounded-xl border border-white/10 min-h-[180px] shadow-inner relative overflow-hidden">
          <div className="flex items-center gap-2 mb-4 text-xs font-bold tracking-wider text-slate-500 uppercase">
            <BrainCircuit size={14} className={currentTheme.color} /> Neural Process
          </div>
          <p className={`font-mono text-sm leading-relaxed ${currentTheme.color} typing-effect`}>
            {">"} {agentThought}
          </p>
        </div>
      </aside>

      <style>{`
        @keyframes morph {
          0% { border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; }
          50% { border-radius: 30% 60% 70% 40% / 50% 60% 30% 60%; }
          100% { border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; }
        }
      `}</style>
    </div>
  );
};

export default App;